### Debezium CDC Fun

Change Data Capture system with Debezium, Kafka, PostgreSQL 17, Spring Boot 3.5.5 (Java 25), and Go 1.25 consumer.

### Architecture

- **PostgreSQL 17**: Database with WAL enabled for CDC
- **Spring Boot 3.5.5**: Java 23 application with REST endpoints
- **Kafka 3.9.0**: Event streaming platform
- **Zookeeper 3.0**: Kafka coordination
- **Debezium Connect 3.0**: CDC connector
- **Go 1.25**: Kafka consumer printing CDC events

### Quick Start

```bash
./run.sh
```

This starts all containers with restart policies. Services may take 1-2 minutes to fully stabilize.

### Manual Setup (if needed)

If services don't stabilize automatically:

```bash
podman-compose up -d
podman ps
podman logs debezium-cdc-fun_kafka_1
```

Wait for Kafka to show: `started (kafka.server.KafkaServer)`

Then register the Debezium connector:

```bash
./setup-connector.sh
```

Or manually:

```bash
curl -i -X POST -H "Content-Type: application/json" \
  --data @debezium-connector.json \
  http://localhost:8083/connectors
```

### Test CDC Pipeline

```bash
./test.sh
```

Or manually:

```bash
curl http://localhost:8080/generate
podman logs debezium-cdc-fun_go-consumer_1
```

### Stop System

```bash
./stop.sh
```

### Endpoints

- Generate data: `http://localhost:8080/generate`
- Get all data: `http://localhost:8080/getdata`
- Debezium Connect: `http://localhost:8083`
- PostgreSQL: `localhost:5432` (postgres/postgres)

### Troubleshooting

Check individual service logs:

```bash
podman logs debezium-cdc-fun_app_1
podman logs debezium-cdc-fun_kafka_1
podman logs debezium-cdc-fun_debezium_1
podman logs debezium-cdc-fun_go-consumer_1
```

Restart specific service:

```bash
podman restart debezium-cdc-fun_kafka_1
```

### How It Works

1. Java app writes data to PostgreSQL
2. Debezium captures database changes via PostgreSQL WAL
3. Changes are streamed to Kafka topic `dbserver1.public.data_events`
4. Go consumer reads and prints CDC events from Kafka

## Results

```bash
❯ ./setup-connector.sh
Waiting for Debezium Connect to be ready...
Debezium Connect is ready!
Registering Debezium connector...
HTTP/1.1 201 Created
Date: Wed, 08 Oct 2025 08:14:19 GMT
Location: http://localhost:8083/connectors/postgres-connector
Content-Type: application/json
Content-Length: 398
Server: Jetty(9.4.56.v20240826)

{"name":"postgres-connector","config":{"connector.class":"io.debezium.connector.postgresql.PostgresConnector","database.hostname":"postgres","database.port":"5432","database.user":"postgres","database.password":"postgres","database.dbname":"cdcdb","topic.prefix":"dbserver1","table.include.list":"public.data_events","plugin.name":"pgoutput","name":"postgres-connector"},"tasks":[],"type":"source"}
Connector registered!
❯ cls
❯ ./test.sh
Testing CDC pipeline...

Generating data via REST endpoint...
Response: {"id":2,"data":"Data-2ec37a64-2f78-4627-830a-d44839827d8d","createdAt":"2025-10-08T08:14:37.838907169"}

Showing Java 25 app - logs...
	Database JDBC URL [Connecting through datasource 'HikariDataSource (HikariPool-1)']
	Database driver: undefined/unknown
	Database version: 17.6
	Autocommit mode: undefined/unknown
	Isolation level: undefined/unknown
	Minimum pool size: undefined/unknown
	Maximum pool size: undefined/unknown
2025-10-08T07:29:53.309Z  INFO 1 --- [debezium-cdc-fun] [           main] o.h.e.t.j.p.i.JtaPlatformInitiator       : HHH000489: No JTA platform available (set 'hibernate.transaction.jta.platform' to enable JTA platform integration)
Hibernate: create table data_events (id bigint generated by default as identity, created_at timestamp(6), data varchar(255), primary key (id))
2025-10-08T07:29:53.334Z  INFO 1 --- [debezium-cdc-fun] [           main] j.LocalContainerEntityManagerFactoryBean : Initialized JPA EntityManagerFactory for persistence unit 'default'
2025-10-08T07:29:53.416Z  WARN 1 --- [debezium-cdc-fun] [           main] JpaBaseConfiguration$JpaWebConfiguration : spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2025-10-08T07:29:53.535Z  INFO 1 --- [debezium-cdc-fun] [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port 8080 (http) with context path '/'
2025-10-08T07:29:53.538Z  INFO 1 --- [debezium-cdc-fun] [           main] c.g.diegopacheco.javapocs.debezium.Main  : Started Main in 2.28 seconds (process running for 2.636)
2025-10-08T07:31:21.433Z  INFO 1 --- [debezium-cdc-fun] [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
2025-10-08T07:31:21.433Z  INFO 1 --- [debezium-cdc-fun] [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
2025-10-08T07:31:21.434Z  INFO 1 --- [debezium-cdc-fun] [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 1 ms
Hibernate: select de1_0.id,de1_0.created_at,de1_0.data from data_events de1_0
Hibernate: insert into data_events (created_at,data) values (?,?)
Hibernate: select de1_0.id,de1_0.created_at,de1_0.data from data_events de1_0
Hibernate: insert into data_events (created_at,data) values (?,?)
Showing Kafka logs...
2025-10-08 07:29:56,240 - INFO  [executor-Rebalance:Logging@66] - [GroupCoordinator 1]: Stabilized group go-consumer-group generation 1 (__consumer_offsets-49) with 1 members
2025-10-08 07:29:56,244 - INFO  [data-plane-kafka-request-handler-4:Logging@66] - Creating topic dbserver1.public.data_events with configuration {} and initial partition assignment HashMap(0 -> ArrayBuffer(1))
2025-10-08 07:29:56,251 - INFO  [data-plane-kafka-request-handler-6:Logging@66] - [GroupCoordinator 1]: Preparing to rebalance group go-consumer-group in state PreparingRebalance with old generation 1 (__consumer_offsets-49) (reason: Removing member consumer@c43f6da702bf (github.com/segmentio/kafka-go)-7d4be705-84f1-4852-a5a4-3d61ebbf87df on LeaveGroup; client reason: not provided)
2025-10-08 07:29:56,252 - INFO  [data-plane-kafka-request-handler-6:Logging@66] - [GroupCoordinator 1]: Group go-consumer-group with generation 2 is now empty (__consumer_offsets-49)
2025-10-08 07:29:56,253 - INFO  [data-plane-kafka-request-handler-6:Logging@66] - [GroupCoordinator 1]: Member MemberMetadata(memberId=consumer@c43f6da702bf (github.com/segmentio/kafka-go)-7d4be705-84f1-4852-a5a4-3d61ebbf87df, groupInstanceId=None, clientId=consumer@c43f6da702bf (github.com/segmentio/kafka-go), clientHost=/10.89.1.7, sessionTimeoutMs=30000, rebalanceTimeoutMs=30000, supportedProtocols=List(range, roundrobin)) has left group go-consumer-group through explicit `LeaveGroup`; client reason: not provided
2025-10-08 07:29:56,255 - INFO  [data-plane-kafka-request-handler-5:Logging@66] - [ReplicaFetcherManager on broker 1] Removed fetcher for partitions Set(dbserver1.public.data_events-0)
2025-10-08 07:29:56,257 - INFO  [data-plane-kafka-request-handler-5:UnifiedLog$@1966] - [LogLoader partition=dbserver1.public.data_events-0, dir=/kafka/data/1] Loading producer state till offset 0 with message format version 2
2025-10-08 07:29:56,257 - INFO  [data-plane-kafka-request-handler-5:Logging@66] - Created log for partition dbserver1.public.data_events-0 in /kafka/data/1/dbserver1.public.data_events-0 with properties {}
2025-10-08 07:29:56,257 - INFO  [data-plane-kafka-request-handler-5:Logging@66] - [Partition dbserver1.public.data_events-0 broker=1] No checkpointed highwatermark is found for partition dbserver1.public.data_events-0
2025-10-08 07:29:56,257 - INFO  [data-plane-kafka-request-handler-5:Logging@66] - [Partition dbserver1.public.data_events-0 broker=1] Log loaded for partition dbserver1.public.data_events-0 with initial high watermark 0
2025-10-08 07:30:01,260 - INFO  [data-plane-kafka-request-handler-3:Logging@66] - [GroupCoordinator 1]: Dynamic Member with unknown member id joins group go-consumer-group in Empty state. Created a new member id consumer@c43f6da702bf (github.com/segmentio/kafka-go)-f43c42a5-b34c-4e72-96fb-f50e3146b04f for this member and add to the group.
2025-10-08 07:30:01,260 - INFO  [data-plane-kafka-request-handler-3:Logging@66] - [GroupCoordinator 1]: Preparing to rebalance group go-consumer-group in state PreparingRebalance with old generation 2 (__consumer_offsets-49) (reason: Adding new member consumer@c43f6da702bf (github.com/segmentio/kafka-go)-f43c42a5-b34c-4e72-96fb-f50e3146b04f with group instance id None; client reason: not provided)
2025-10-08 07:30:01,261 - INFO  [executor-Rebalance:Logging@66] - [GroupCoordinator 1]: Stabilized group go-consumer-group generation 3 (__consumer_offsets-49) with 1 members
2025-10-08 07:30:01,263 - INFO  [data-plane-kafka-request-handler-1:Logging@66] - [GroupCoordinator 1]: Assignment received from leader consumer@c43f6da702bf (github.com/segmentio/kafka-go)-f43c42a5-b34c-4e72-96fb-f50e3146b04f for group go-consumer-group for generation 3. The group has 1 members, 0 of which are static.
2025-10-08 08:14:19,898 - INFO  [data-plane-kafka-request-handler-6:Logging@66] - [GroupCoordinator 1]: Preparing to rebalance group 1 in state PreparingRebalance with old generation 1 (__consumer_offsets-49) (reason: Leader connect-10.89.1.6:8083-c03f34c9-3064-42e9-bbab-751fa042a717 re-joining group during Stable; client reason: )
2025-10-08 08:14:19,898 - INFO  [data-plane-kafka-request-handler-6:Logging@66] - [GroupCoordinator 1]: Stabilized group 1 generation 2 (__consumer_offsets-49) with 1 members
2025-10-08 08:14:19,900 - INFO  [data-plane-kafka-request-handler-0:Logging@66] - [GroupCoordinator 1]: Assignment received from leader connect-10.89.1.6:8083-c03f34c9-3064-42e9-bbab-751fa042a717 for group 1 for generation 2. The group has 1 members, 0 of which are static.
2025-10-08 08:14:20,336 - INFO  [data-plane-kafka-request-handler-3:Logging@66] - [GroupCoordinator 1]: Preparing to rebalance group 1 in state PreparingRebalance with old generation 2 (__consumer_offsets-49) (reason: Leader connect-10.89.1.6:8083-c03f34c9-3064-42e9-bbab-751fa042a717 re-joining group during Stable; client reason: )
2025-10-08 08:14:20,336 - INFO  [data-plane-kafka-request-handler-3:Logging@66] - [GroupCoordinator 1]: Stabilized group 1 generation 3 (__consumer_offsets-49) with 1 members
2025-10-08 08:14:20,339 - INFO  [data-plane-kafka-request-handler-5:Logging@66] - [GroupCoordinator 1]: Assignment received from leader connect-10.89.1.6:8083-c03f34c9-3064-42e9-bbab-751fa042a717 for group 1 for generation 3. The group has 1 members, 0 of which are static.

Showing Debezium logs...
2025-10-08 08:14:20,487 INFO   Postgres|dbserver1|snapshot  Snapshot step 4 - Determining snapshot offset   [io.debezium.relational.RelationalSnapshotChangeEventSource]
2025-10-08 08:14:20,487 INFO   Postgres|dbserver1|snapshot  Creating initial offset context   [io.debezium.connector.postgresql.PostgresOffsetContext]
2025-10-08 08:14:20,488 INFO   Postgres|dbserver1|snapshot  Read xlogStart at 'LSN{0/197F6E0}' from transaction '754'   [io.debezium.connector.postgresql.PostgresOffsetContext]
2025-10-08 08:14:20,489 INFO   Postgres|dbserver1|snapshot  Read xlogStart at 'LSN{0/197F6E0}' from transaction '754'   [io.debezium.connector.postgresql.PostgresSnapshotChangeEventSource]
2025-10-08 08:14:20,489 INFO   Postgres|dbserver1|snapshot  Snapshot step 5 - Reading structure of captured tables   [io.debezium.relational.RelationalSnapshotChangeEventSource]
2025-10-08 08:14:20,489 INFO   Postgres|dbserver1|snapshot  Reading structure of schema 'public' of catalog 'cdcdb'   [io.debezium.connector.postgresql.PostgresSnapshotChangeEventSource]
2025-10-08 08:14:20,501 INFO   Postgres|dbserver1|snapshot  Snapshot step 6 - Persisting schema history   [io.debezium.relational.RelationalSnapshotChangeEventSource]
2025-10-08 08:14:20,501 INFO   Postgres|dbserver1|snapshot  Snapshot step 7 - Snapshotting data   [io.debezium.relational.RelationalSnapshotChangeEventSource]
2025-10-08 08:14:20,502 INFO   Postgres|dbserver1|snapshot  Creating snapshot worker pool with 1 worker thread(s)   [io.debezium.relational.RelationalSnapshotChangeEventSource]
2025-10-08 08:14:20,502 INFO   Postgres|dbserver1|snapshot  For table 'public.data_events' using select statement: 'SELECT "id", "created_at", "data" FROM "public"."data_events"'   [io.debezium.relational.RelationalSnapshotChangeEventSource]
2025-10-08 08:14:20,504 INFO   Postgres|dbserver1|snapshot  Exporting data from table 'public.data_events' (1 of 1 tables)   [io.debezium.relational.RelationalSnapshotChangeEventSource]
2025-10-08 08:14:20,510 INFO   Postgres|dbserver1|snapshot  	 Finished exporting 1 records for table 'public.data_events' (1 of 1 tables); total duration '00:00:00.006'   [io.debezium.relational.RelationalSnapshotChangeEventSource]
2025-10-08 08:14:20,511 INFO   Postgres|dbserver1|snapshot  Snapshot - Final stage   [io.debezium.pipeline.source.AbstractSnapshotChangeEventSource]
2025-10-08 08:14:20,511 INFO   Postgres|dbserver1|snapshot  Snapshot completed   [io.debezium.pipeline.source.AbstractSnapshotChangeEventSource]
2025-10-08 08:14:20,513 INFO   Postgres|dbserver1|snapshot  Snapshot ended with SnapshotResult [status=COMPLETED, offset=PostgresOffsetContext [sourceInfoSchema=Schema{io.debezium.connector.postgresql.Source:STRUCT}, sourceInfo=source_info[server='dbserver1'db='cdcdb', lsn=LSN{0/197F6E0}, txId=754, timestamp=2025-10-08T08:14:20.461224Z, snapshot=FALSE, schema=public, table=data_events], lastSnapshotRecord=true, lastCompletelyProcessedLsn=null, lastCommitLsn=null, streamingStoppingLsn=null, transactionContext=TransactionContext [currentTransactionId=null, perTableEventCount={}, totalEventCount=0], incrementalSnapshotContext=IncrementalSnapshotContext [windowOpened=false, chunkEndPosition=null, dataCollectionsToSnapshot=[], lastEventKeySent=null, maximumKey=null]]]   [io.debezium.pipeline.ChangeEventSourceCoordinator]
2025-10-08 08:14:20,514 INFO   Postgres|dbserver1|streaming  Connected metrics set to 'true'   [io.debezium.pipeline.ChangeEventSourceCoordinator]
2025-10-08 08:14:20,524 INFO   Postgres|dbserver1|streaming  REPLICA IDENTITY for 'public.data_events' is 'DEFAULT'; UPDATE and DELETE events will contain previous values only for PK columns   [io.debezium.connector.postgresql.PostgresSchema]
2025-10-08 08:14:20,526 INFO   Postgres|dbserver1|streaming  SignalProcessor started. Scheduling it every 5000ms   [io.debezium.pipeline.signal.SignalProcessor]
2025-10-08 08:14:20,526 INFO   Postgres|dbserver1|streaming  Creating thread debezium-postgresconnector-dbserver1-SignalProcessor   [io.debezium.util.Threads]
2025-10-08 08:14:20,526 INFO   Postgres|dbserver1|streaming  Starting streaming   [io.debezium.pipeline.ChangeEventSourceCoordinator]
2025-10-08 08:14:20,526 INFO   Postgres|dbserver1|streaming  Retrieved latest position from stored offset 'LSN{0/197F6E0}'   [io.debezium.connector.postgresql.PostgresStreamingChangeEventSource]
2025-10-08 08:14:20,526 INFO   Postgres|dbserver1|streaming  Looking for WAL restart position for last commit LSN 'null' and last change LSN 'LSN{0/197F6E0}'   [io.debezium.connector.postgresql.connection.WalPositionLocator]
2025-10-08 08:14:20,527 INFO   Postgres|dbserver1|streaming  Initializing PgOutput logical decoder publication   [io.debezium.connector.postgresql.connection.PostgresReplicationConnection]
2025-10-08 08:14:20,545 INFO   Postgres|dbserver1|streaming  Obtained valid replication slot ReplicationSlot [active=false, latestFlushedLsn=LSN{0/197F6E0}, catalogXmin=754]   [io.debezium.connector.postgresql.connection.PostgresConnection]
2025-10-08 08:14:20,545 INFO   Postgres|dbserver1|streaming  Connection gracefully closed   [io.debezium.jdbc.JdbcConnection]
2025-10-08 08:14:20,558 INFO   Postgres|dbserver1|streaming  Requested thread factory for component PostgresConnector, id = dbserver1 named = keep-alive   [io.debezium.util.Threads]
2025-10-08 08:14:20,558 INFO   Postgres|dbserver1|streaming  Creating thread debezium-postgresconnector-dbserver1-keep-alive   [io.debezium.util.Threads]
2025-10-08 08:14:20,567 INFO   Postgres|dbserver1|streaming  REPLICA IDENTITY for 'public.data_events' is 'DEFAULT'; UPDATE and DELETE events will contain previous values only for PK columns   [io.debezium.connector.postgresql.PostgresSchema]
2025-10-08 08:14:20,568 INFO   Postgres|dbserver1|streaming  Processing messages   [io.debezium.connector.postgresql.PostgresStreamingChangeEventSource]
2025-10-08 08:14:38,549 INFO   ||  2 records sent during previous 00:00:18.198, last recorded offset of {server=dbserver1} partition is {lsn_proc=26736448, messageType=INSERT, lsn=26736448, txId=755, ts_usec=1759911277840874}   [io.debezium.connector.common.BaseSourceTask]

Showing Go consumer logs...
2025/10/08 07:29:51 Go consumer started - reading from topic: dbserver1.public.data_events
Received CDC Event - Partition: 0, Offset: 0, Key: {"schema":{"type":"struct","fields":[{"type":"int64","optional":false,"field":"id"}],"optional":false,"name":"dbserver1.public.data_events.Key"},"payload":{"id":1}}, Value: {"schema":{"type":"struct","fields":[{"type":"struct","fields":[{"type":"int64","optional":false,"field":"id"},{"type":"int64","optional":true,"name":"io.debezium.time.MicroTimestamp","version":1,"field":"created_at"},{"type":"string","optional":true,"field":"data"}],"optional":true,"name":"dbserver1.public.data_events.Value","field":"before"},{"type":"struct","fields":[{"type":"int64","optional":false,"field":"id"},{"type":"int64","optional":true,"name":"io.debezium.time.MicroTimestamp","version":1,"field":"created_at"},{"type":"string","optional":true,"field":"data"}],"optional":true,"name":"dbserver1.public.data_events.Value","field":"after"},{"type":"struct","fields":[{"type":"string","optional":false,"field":"version"},{"type":"string","optional":false,"field":"connector"},{"type":"string","optional":false,"field":"name"},{"type":"int64","optional":false,"field":"ts_ms"},{"type":"string","optional":true,"name":"io.debezium.data.Enum","version":1,"parameters":{"allowed":"true,first,first_in_data_collection,last_in_data_collection,last,false,incremental"},"default":"false","field":"snapshot"},{"type":"string","optional":false,"field":"db"},{"type":"string","optional":true,"field":"sequence"},{"type":"int64","optional":true,"field":"ts_us"},{"type":"int64","optional":true,"field":"ts_ns"},{"type":"string","optional":false,"field":"schema"},{"type":"string","optional":false,"field":"table"},{"type":"int64","optional":true,"field":"txId"},{"type":"int64","optional":true,"field":"lsn"},{"type":"int64","optional":true,"field":"xmin"}],"optional":false,"name":"io.debezium.connector.postgresql.Source","field":"source"},{"type":"struct","fields":[{"type":"string","optional":false,"field":"id"},{"type":"int64","optional":false,"field":"total_order"},{"type":"int64","optional":false,"field":"data_collection_order"}],"optional":true,"name":"event.block","version":1,"field":"transaction"},{"type":"string","optional":false,"field":"op"},{"type":"int64","optional":true,"field":"ts_ms"},{"type":"int64","optional":true,"field":"ts_us"},{"type":"int64","optional":true,"field":"ts_ns"}],"optional":false,"name":"dbserver1.public.data_events.Envelope","version":2},"payload":{"before":null,"after":{"id":1,"created_at":1759908734268321,"data":"Data-a3354714-6ac9-4eb4-854b-a578efa2e7dd"},"source":{"version":"3.0.8.Final","connector":"postgresql","name":"dbserver1","ts_ms":1759911260461,"snapshot":"last","db":"cdcdb","sequence":"[null,\"26736352\"]","ts_us":1759911260461224,"ts_ns":1759911260461224000,"schema":"public","table":"data_events","txId":754,"lsn":26736352,"xmin":null},"transaction":null,"op":"r","ts_ms":1759911260509,"ts_us":1759911260509843,"ts_ns":1759911260509843621}}

Getting all data from Java app...
[
  {
    "id": 1,
    "data": "Data-a3354714-6ac9-4eb4-854b-a578efa2e7dd",
    "createdAt": "2025-10-08T07:32:14.268321"
  },
  {
    "id": 2,
    "data": "Data-2ec37a64-2f78-4627-830a-d44839827d8d",
    "createdAt": "2025-10-08T08:14:37.838907"
  }
]

Test completed!
```